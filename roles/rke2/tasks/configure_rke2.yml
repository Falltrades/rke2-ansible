---

- name: Create the /etc/rancher/rke2 config dir
  ansible.builtin.file:
    path: /etc/rancher/rke2
    state: directory
    recurse: yes

- name: Run CIS-Hardening Tasks
  ansible.builtin.include_tasks: cis-hardening.yml

- name: Configure registries.yaml
  ansible.builtin.include_tasks: add-registry-config.yml

- name: Configure audit policy
  ansible.builtin.include_tasks: add-audit-policy-config.yml
  when:
    - inventory_hostname in groups['rke2_servers']

- name: Configure psa policy
  ansible.builtin.include_tasks: add-pod-security-admission-config.yml
  when:
    - inventory_hostname in groups['rke2_servers']

- name: Configure first server manifests
  ansible.builtin.include_tasks: add-manifest-addons.yml
  vars:
    src: "{{ rke2_initial_manifest_config_file_path }}"
  when:
    - inventory_hostname in groups['rke2_servers'][0]
    - rke2_initial_manifest_config_file_path | length > 0
